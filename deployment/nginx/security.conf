# AssayBio 安全配置
# 企业级Web安全防护配置

# ====================
# 基础安全设置
# ====================

# 隐藏服务器版本信息
server_tokens off;
more_set_headers "Server: AssayBio/1.0";

# ====================
# DDoS 和速率限制
# ====================

# IP频率限制区域
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=search:10m rate=30r/m;

# 连接数限制
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# 白名单IP
geo $whitelist {
    default 0;
    127.0.0.1 1;
    192.3.11.106 1;     # 服务器IP
    # 10.0.0.0/8 1;      # 内网IP段
    # 可以添加更多可信IP
}

# ====================
# User-Agent 过滤
# ====================
map $http_user_agent $blocked_agent {
    default 0;
    "~*malicious" 1;
    "~*bot" 1;
    "~*spider" 1;
    "~*crawler" 1;
    "~*BadBot" 1;
    "~*SemrushBot" 1;
    "~*AhrefsBot" 1;
    "~*MJ12bot" 1;
    "" 1;  # 空User-Agent
}

# 允许的爬虫
map $http_user_agent $good_bot {
    default 0;
    "~*Googlebot" 1;
    "~*Bingbot" 1;
    "~*baiduSpider" 1;
}

# 最终bot判断
map $blocked_agent$good_bot $deny_agent {
    "00" 0;  # 正常用户
    "01" 0;  # 好的爬虫
    "10" 1;  # 恶意爬虫
    "11" 0;  # 好的爬虫优先
}

# ====================
# 恶意请求检测
# ====================

# SQL注入检测
map $args $sql_injection {
    default 0;
    "~*union.*select" 1;
    "~*select.*from" 1;
    "~*insert.*into" 1;
    "~*delete.*from" 1;
    "~*drop.*table" 1;
    "~*update.*set" 1;
    "~*exec.*xp_" 1;
}

# XSS攻击检测
map $args $xss_attack {
    default 0;
    "~*<script" 1;
    "~*javascript:" 1;
    "~*onclick=" 1;
    "~*onload=" 1;
    "~*onerror=" 1;
    "~*alert\(" 1;
    "~*document\.cookie" 1;
}

# 路径遍历检测
map $uri$args $path_traversal {
    default 0;
    "~*\.\." 1;
    "~*/etc/passwd" 1;
    "~*/proc/self/environ" 1;
    "~*\x00" 1;
    "~*%00" 1;
}

# 综合恶意请求判断
map $sql_injection$xss_attack$path_traversal $malicious_request {
    "000" 0;  # 正常请求
    default 1;  # 恶意请求
}

# ====================
# 国家/地区限制
# ====================
# geo $country {
#     default no;
#     include /etc/nginx/geo/countries.conf;
# }

# map $country $allowed_country {
#     default 1;
#     no 0;
#     # 可以添加特定国家限制
# }

# ====================
# 请求大小限制
# ====================
map $request_method $upload_limit {
    default 1m;
    POST 100m;
    PUT 100m;
}

# ====================
# 文件上传安全
# ====================
map $request_filename $upload_extension {
    default 0;
    ~*\.(php|asp|aspx|jsp|py|rb|sh|cgi)$ 1;
    ~*\.(exe|bat|cmd|com|pif|scr|vbs)$ 1;
}

# ====================
# HTTP方法限制
# ====================
map $request_method $not_allowed_method {
    default 1;
    GET 0;
    HEAD 0;
    POST 0;
    OPTIONS 0;
}

# ====================
# Referer检查
# ====================
map $http_referer $invalid_referer {
    default 0;
    "~*malware-site.com" 1;
    "~*phishing-site.com" 1;
    "~*spam-site.com" 1;
}

# ====================
# SSL/TLS 安全配置
# ====================
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers off;

# OCSP装订
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/letsencrypt/live/www.assaybio.com/chain.pem;

# DNS解析器
resolver 1.1.1.1 8.8.8.8 valid=300s;
resolver_timeout 5s;

# ====================
# 安全头部配置
# ====================

# 基础安全头部
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=(), interest-cohort=()" always;

# HSTS (HTTPS严格传输安全)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# 内容安全策略 (CSP)
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 
        *.assaybio.com 
        *.googleapis.com 
        *.gstatic.com;
    style-src 'self' 'unsafe-inline' 
        *.assaybio.com 
        fonts.googleapis.com;
    font-src 'self' 
        *.assaybio.com 
        fonts.gstatic.com 
        data:;
    img-src 'self' data: 
        *.assaybio.com 
        *.gravatar.com;
    connect-src 'self' 
        *.assaybio.com;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
" always;

# ====================
# 日志配置
# ====================

# 安全事件日志格式
log_format security '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'blocked_agent=$deny_agent malicious=$malicious_request '
                   'sql_injection=$sql_injection xss_attack=$xss_attack '
                   'path_traversal=$path_traversal';

# ====================
# 实时阻断规则
# ====================

# 在server块中使用这些检查：
# 
# # 阻断恶意User-Agent
# if ($deny_agent) {
#     return 403 "Forbidden: Blocked User-Agent";
# }
# 
# # 阻断恶意请求
# if ($malicious_request) {
#     access_log /var/log/nginx/security.log security;
#     return 403 "Forbidden: Malicious Request Detected";
# }
# 
# # 阻断不允许的HTTP方法
# if ($not_allowed_method) {
#     return 405 "Method Not Allowed";
# }
# 
# # 阻断可执行文件上传
# if ($upload_extension) {
#     return 403 "Forbidden: File Type Not Allowed";
# }

# ====================
# Fail2Ban 集成
# ====================

# 在 /etc/fail2ban/jail.local 中添加：
# [nginx-limit-req]
# enabled = true
# filter = nginx-limit-req
# action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
# logpath = /var/log/nginx/error.log
# findtime = 600
# bantime = 7200
# maxretry = 10