name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  deploy:
    name: ğŸŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
        
    - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…
      run: |
        echo "ğŸ”¨ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy-package
        
        # å¤åˆ¶ç½‘ç«™æ–‡ä»¶
        cp -r apps/website/dist/* deploy-package/ 2>/dev/null || true
        cp -r css deploy-package/ 2>/dev/null || true
        cp -r js deploy-package/ 2>/dev/null || true
        cp -r images deploy-package/ 2>/dev/null || true
        cp -r icons deploy-package/ 2>/dev/null || true
        cp index.html deploy-package/ 2>/dev/null || true
        cp apps/website/temp.json deploy-package/ 2>/dev/null || true
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        echo "{
          \"version\": \"${{ github.sha }}\",
          \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
          \"branch\": \"${{ github.ref_name }}\",
          \"commit_message\": \"${{ github.event.head_commit.message }}\"
        }" > deploy-package/version.json
        
        # æ‰“åŒ…
        tar -czf website-deploy.tar.gz -C deploy-package .
        ls -la website-deploy.tar.gz
        
    - name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      run: |
        echo "ğŸŒ å¼€å§‹éƒ¨ç½²åˆ° 192.3.11.106:6500"
        
        # è®¾ç½®SSHå¯†é’¥ï¼ˆå¦‚æœé…ç½®äº†çš„è¯ï¼‰
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY || 'dummy' }}" > ~/.ssh/id_rsa || echo "æœªé…ç½®SSHå¯†é’¥ï¼Œå°†ä½¿ç”¨webhookæ–¹å¼"
        chmod 600 ~/.ssh/id_rsa || true
        
        # æ–¹å¼1: é€šè¿‡SSHç›´æ¥éƒ¨ç½²ï¼ˆå¦‚æœSSHå¯†é’¥å¯ç”¨ï¼‰
        if [ -f ~/.ssh/id_rsa ] && [ -s ~/.ssh/id_rsa ] && [ "${{ secrets.SERVER_SSH_KEY }}" != "" ]; then
          echo "ğŸ“¡ ä½¿ç”¨SSHæ–¹å¼éƒ¨ç½²..."
          scp -o StrictHostKeyChecking=no website-deploy.tar.gz root@192.3.11.106:/tmp/
          ssh -o StrictHostKeyChecking=no root@192.3.11.106 << 'EOF'
            cd /var/www/html
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz * 2>/dev/null || true
            # æ¸…ç†æ—§æ–‡ä»¶
            rm -rf * 2>/dev/null || true
            # è§£å‹æ–°ç‰ˆæœ¬
            tar -xzf /tmp/website-deploy.tar.gz -C /var/www/html/
            # è®¾ç½®æƒé™
            chown -R www-data:www-data /var/www/html/ 2>/dev/null || chown -R nginx:nginx /var/www/html/ 2>/dev/null || true
            chmod -R 644 /var/www/html/*
            # é‡å¯æœåŠ¡
            systemctl reload nginx 2>/dev/null || service nginx reload 2>/dev/null || true
            echo "âœ… SSHéƒ¨ç½²å®Œæˆ"
        EOF
        else
          echo "ğŸ“¡ ä½¿ç”¨Webhookæ–¹å¼è§¦å‘éƒ¨ç½²..."
          # æ–¹å¼2: é€šè¿‡Webhookè§¦å‘æœåŠ¡å™¨ç«¯è„šæœ¬
          curl -X POST "http://192.3.11.106:3000/deploy" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "X-Hub-Signature-256: sha256=${{ github.sha }}" \
            -d '{
              "repository": {
                "name": "${{ github.repository }}",
                "clone_url": "${{ github.repositoryUrl }}"
              },
              "head_commit": {
                "id": "${{ github.sha }}",
                "message": "${{ github.event.head_commit.message }}",
                "timestamp": "${{ github.event.head_commit.timestamp }}"
              },
              "ref": "${{ github.ref }}",
              "deploy_url": "https://github.com/${{ github.repository }}/archive/${{ github.sha }}.tar.gz"
            }' || echo "Webhookè§¦å‘å¤±è´¥ï¼Œå°†å°è¯•å¤‡ç”¨æ–¹æ¡ˆ"
            
          # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥HTTPè¯·æ±‚
          curl -f "http://192.3.11.106:8080/update?token=github-deploy-2025" || echo "å¤‡ç”¨éƒ¨ç½²è§¦å‘å¤±è´¥"
        fi
        
    - name: ğŸ” éƒ¨ç½²éªŒè¯
      run: |
        echo "ğŸ• ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        sleep 10
        
        # æ£€æŸ¥ç½‘ç«™æ˜¯å¦æ­£å¸¸
        if curl -f -s "http://192.3.11.106:6500/" > /dev/null; then
          echo "âœ… ç½‘ç«™éƒ¨ç½²æˆåŠŸï¼Œæ­£å¸¸è®¿é—®"
          # æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä¸ä¾èµ–jqï¼‰
          VERSION_RESPONSE=$(curl -f -s "http://192.3.11.106:6500/version.json" || echo "")
          if [ -n "$VERSION_RESPONSE" ] && echo "$VERSION_RESPONSE" | grep -q "${{ github.sha }}"; then
            echo "âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: ${{ github.sha }}"
          else
            echo "âš ï¸  ç‰ˆæœ¬ä¿¡æ¯æ£€æŸ¥è·³è¿‡ï¼Œä½†ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
          fi
        else
          echo "âŒ ç½‘ç«™è®¿é—®å¤±è´¥ï¼Œå°è¯•åŸºæœ¬çš„è¿é€šæ€§æµ‹è¯•..."
          # åŸºæœ¬è¿é€šæ€§æµ‹è¯•
          if ping -c 1 192.3.11.106 > /dev/null 2>&1; then
            echo "âœ… æœåŠ¡å™¨å¯è¾¾"
            echo "âš ï¸  ç«¯å£6500å¯èƒ½æœªå¼€æ”¾æˆ–æœåŠ¡æœªå¯åŠ¨"
          else
            echo "âŒ æœåŠ¡å™¨ä¸å¯è¾¾"
          fi
          # ä¸é€€å‡ºï¼Œå…è®¸éƒ¨ç½²ç»§ç»­
        fi
        
    - name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          echo "âœ… ç½‘ç«™å·²æˆåŠŸéƒ¨ç½²åˆ° http://192.3.11.106:6500/"
          echo "ğŸ“Š ç‰ˆæœ¬: ${{ github.sha }}"
          echo "ğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥"
          echo "ğŸ’¥ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi

  cleanup:
    name: ğŸ§¹ æ¸…ç†ä»»åŠ¡
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ§¹ æ¸…ç†æœåŠ¡å™¨ä¸´æ—¶æ–‡ä»¶
      run: |
        echo "ğŸ§¹ æ¸…ç†éƒ¨ç½²ä¸´æ—¶æ–‡ä»¶..."
        curl -X POST "http://192.3.11.106:3000/cleanup" \
          -H "Authorization: Bearer github-cleanup-token" \
          -d '{"action": "cleanup_temp_files"}' || echo "æ¸…ç†è¯·æ±‚å‘é€å®Œæˆ"