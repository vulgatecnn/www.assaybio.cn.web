name: 'Blue-Green Deployment'
description: 'Zero-downtime deployment using blue-green strategy'

inputs:
  server-host:
    description: 'Target server hostname or IP'
    required: true
  server-user:
    description: 'SSH username for target server'
    required: true
  server-key:
    description: 'SSH private key for authentication'
    required: true
  image-tag:
    description: 'Docker image tag to deploy'
    required: true
  health-check-url:
    description: 'URL for health check'
    required: true

runs:
  using: 'composite'
  steps:
    - name: ğŸ”§ Setup SSH
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ inputs.server-key }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ inputs.server-host }} >> ~/.ssh/known_hosts

    - name: ğŸ“¤ Upload Deployment Scripts
      shell: bash
      run: |
        scp -i ~/.ssh/deploy_key -r deployment/ ${{ inputs.server-user }}@${{ inputs.server-host }}:/tmp/blue-green-deploy/

    - name: ğŸ”µ Deploy to Blue Environment
      shell: bash
      run: |
        ssh -i ~/.ssh/deploy_key ${{ inputs.server-user }}@${{ inputs.server-host }} << 'EOF'
          set -e
          
          # è·å–å½“å‰æ´»è·ƒç¯å¢ƒ
          if docker ps --format "table {{.Names}}" | grep -q assaybio-green; then
            ACTIVE_ENV="green"
            TARGET_ENV="blue"
            ACTIVE_PORT=8080
            TARGET_PORT=8081
          else
            ACTIVE_ENV="blue"
            TARGET_ENV="green"
            ACTIVE_PORT=8081
            TARGET_PORT=8080
          fi
          
          echo "ğŸ”„ Active: $ACTIVE_ENV, Target: $TARGET_ENV"
          
          # åœæ­¢ç›®æ ‡ç¯å¢ƒï¼ˆå¦‚æœè¿è¡Œä¸­ï¼‰
          docker stop assaybio-$TARGET_ENV || true
          docker rm assaybio-$TARGET_ENV || true
          
          # å¯åŠ¨æ–°ç‰ˆæœ¬åˆ°ç›®æ ‡ç¯å¢ƒ
          docker run -d \
            --name assaybio-$TARGET_ENV \
            --network assaybio-network \
            -p $TARGET_PORT:80 \
            -e ENVIRONMENT=production \
            --restart unless-stopped \
            ${{ inputs.image-tag }}
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ Waiting for service to start..."
          sleep 30
        EOF

    - name: ğŸ©º Health Check on Blue Environment
      shell: bash
      run: |
        # æ£€æŸ¥è“ç¯å¢ƒå¥åº·çŠ¶æ€
        for i in {1..10}; do
          if curl -f -s http://${{ inputs.server-host }}:8081/health > /dev/null; then
            echo "âœ… Blue environment health check passed"
            break
          fi
          echo "â³ Health check attempt $i/10 failed, retrying..."
          sleep 10
          
          if [ $i -eq 10 ]; then
            echo "âŒ Health check failed after 10 attempts"
            exit 1
          fi
        done

    - name: ğŸ”€ Switch Traffic to Blue
      shell: bash
      run: |
        ssh -i ~/.ssh/deploy_key ${{ inputs.server-user }}@${{ inputs.server-host }} << 'EOF'
          set -e
          
          # è·å–å½“å‰ç¯å¢ƒçŠ¶æ€
          if docker ps --format "table {{.Names}}" | grep -q assaybio-green; then
            ACTIVE_ENV="green"
            TARGET_ENV="blue"
          else
            ACTIVE_ENV="blue"
            TARGET_ENV="green"
          fi
          
          echo "ğŸ”€ Switching traffic from $ACTIVE_ENV to $TARGET_ENV"
          
          # æ›´æ–°nginxé…ç½®æŒ‡å‘æ–°ç¯å¢ƒ
          cd /tmp/blue-green-deploy
          sed "s/ACTIVE_ENV/$TARGET_ENV/g" nginx/nginx-blue-green.conf > /etc/nginx/sites-available/assaybio
          
          # æµ‹è¯•nginxé…ç½®
          nginx -t
          
          # é‡æ–°è½½å…¥nginxé…ç½®
          systemctl reload nginx
          
          echo "âœ… Traffic switched to $TARGET_ENV environment"
        EOF

    - name: ğŸ©º Final Health Check
      shell: bash
      run: |
        sleep 10
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ inputs.health-check-url }})
        if [ $response -eq 200 ]; then
          echo "âœ… Final health check passed"
        else
          echo "âŒ Final health check failed with status: $response"
          exit 1
        fi

    - name: ğŸ—‘ï¸ Cleanup Old Environment
      shell: bash
      run: |
        ssh -i ~/.ssh/deploy_key ${{ inputs.server-user }}@${{ inputs.server-host }} << 'EOF'
          # ç¡®å®šæ—§ç¯å¢ƒå¹¶æ¸…ç†
          if docker ps --format "table {{.Names}}" | grep -q assaybio-blue; then
            OLD_ENV="green"
          else
            OLD_ENV="blue"
          fi
          
          echo "ğŸ—‘ï¸ Cleaning up old environment: $OLD_ENV"
          
          # ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿æµé‡å·²åˆ‡æ¢
          sleep 60
          
          # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
          docker stop assaybio-$OLD_ENV || true
          docker rm assaybio-$OLD_ENV || true
          
          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
          docker image prune -f
          
          echo "âœ… Cleanup completed"
        EOF

    - name: ğŸ§¹ Cleanup SSH
      shell: bash
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key
        ssh-keyscan -H ${{ inputs.server-host }} >> ~/.ssh/known_hosts