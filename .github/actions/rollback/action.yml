name: 'Rollback Deployment'
description: 'Rollback to previous stable version'

inputs:
  server-host:
    description: 'Target server hostname or IP'
    required: true
  server-user:
    description: 'SSH username for target server'
    required: true
  server-key:
    description: 'SSH private key for authentication'
    required: true

runs:
  using: 'composite'
  steps:
    - name: ğŸ”§ Setup SSH
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ inputs.server-key }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ inputs.server-host }} >> ~/.ssh/known_hosts

    - name: âª Execute Rollback
      shell: bash
      run: |
        ssh -i ~/.ssh/deploy_key ${{ inputs.server-user }}@${{ inputs.server-host }} << 'EOF'
          set -e
          
          echo "ğŸ” Starting rollback process..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¤‡ä»½ç¯å¢ƒå¯ç”¨
          BACKUP_AVAILABLE=false
          if docker ps -a --format "table {{.Names}}" | grep -q assaybio-backup; then
            BACKUP_AVAILABLE=true
            echo "âœ… Backup environment found"
          fi
          
          if [ "$BACKUP_AVAILABLE" = true ]; then
            # ä½¿ç”¨å¤‡ä»½ç¯å¢ƒè¿›è¡Œå¿«é€Ÿå›æ»š
            echo "ğŸ”„ Rolling back using backup environment..."
            
            # åœæ­¢å½“å‰ç¯å¢ƒ
            docker stop assaybio-blue assaybio-green || true
            
            # å¯åŠ¨å¤‡ä»½ç¯å¢ƒ
            docker start assaybio-backup
            
            # æ›´æ–°nginxé…ç½®æŒ‡å‘å¤‡ä»½ç¯å¢ƒ
            sed 's/server localhost:808[01]/server localhost:8082/' /etc/nginx/sites-available/assaybio > /etc/nginx/sites-available/assaybio.rollback
            mv /etc/nginx/sites-available/assaybio.rollback /etc/nginx/sites-available/assaybio
            
            # é‡æ–°è½½å…¥nginx
            nginx -t && systemctl reload nginx
            
            echo "âœ… Rollback completed using backup environment"
          else
            # ä½¿ç”¨æ•°æ®åº“å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
            echo "ğŸ“‹ Retrieving last stable deployment..."
            
            # ä»éƒ¨ç½²æ—¥å¿—ä¸­è·å–ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
            LAST_STABLE_TAG=$(docker images --format "table {{.Repository}}:{{.Tag}}" | grep ghcr.io/assaybio | head -2 | tail -1)
            
            if [ ! -z "$LAST_STABLE_TAG" ]; then
              echo "ğŸ”„ Rolling back to: $LAST_STABLE_TAG"
              
              # åœæ­¢å½“å‰å®¹å™¨
              docker stop assaybio-blue assaybio-green || true
              docker rm assaybio-blue assaybio-green || true
              
              # å¯åŠ¨ç¨³å®šç‰ˆæœ¬
              docker run -d \
                --name assaybio-rollback \
                --network assaybio-network \
                -p 8080:80 \
                -e ENVIRONMENT=production \
                --restart unless-stopped \
                $LAST_STABLE_TAG
              
              # æ›´æ–°nginxé…ç½®
              sed 's/server localhost:808[01]/server localhost:8080/' /etc/nginx/sites-available/assaybio > /etc/nginx/sites-available/assaybio.rollback
              mv /etc/nginx/sites-available/assaybio.rollback /etc/nginx/sites-available/assaybio
              
              # é‡æ–°è½½å…¥nginx
              nginx -t && systemctl reload nginx
              
              echo "âœ… Rollback completed to version: $LAST_STABLE_TAG"
            else
              echo "âŒ No stable version found for rollback"
              exit 1
            fi
          fi
          
          # éªŒè¯å›æ»šæ˜¯å¦æˆåŠŸ
          sleep 10
          if curl -f http://localhost/health > /dev/null 2>&1; then
            echo "âœ… Rollback health check passed"
          else
            echo "âŒ Rollback health check failed"
            exit 1
          fi
        EOF

    - name: ğŸ“Š Verify Rollback
      shell: bash
      run: |
        # éªŒè¯ç½‘ç«™æ˜¯å¦å¯è®¿é—®
        for i in {1..5}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ inputs.server-host }})
          if [ $response -eq 200 ]; then
            echo "âœ… Website is accessible after rollback"
            break
          fi
          echo "â³ Verification attempt $i/5..."
          sleep 5
          
          if [ $i -eq 5 ]; then
            echo "âŒ Website verification failed after rollback"
            exit 1
          fi
        done

    - name: ğŸ§¹ Cleanup SSH
      shell: bash
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key